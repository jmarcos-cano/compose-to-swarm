



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../img/favicon.ico">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.3">
    
    
      
        <title>Docker Swarm - Compose To Swarm</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.30686662.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="#fb8c00">
      
    
    
      <script src="../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Space+Mono:300,400,400i,700|Inconsolata&display=fallback">
        <style>body,input{font-family:"Space Mono","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Inconsolata","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="https://unpkg.com/mermaid@7.1.2/dist/mermaid.css">
    
      <link rel="stylesheet" href="../css/extra.css">
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="orange" data-md-color-accent="blue-grey">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#swarm-steps" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="Compose To Swarm" class="md-header-nav__button md-logo">
          
            <img src="../img/dockergt.png" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Compose To Swarm
            </span>
            <span class="md-header-nav__topic">
              
                Docker Swarm
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/jmarcos-cano/compose-to-swarm/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="Compose To Swarm" class="md-nav__button md-logo">
      
        <img src="../img/dockergt.png" width="48" height="48">
      
    </a>
    Compose To Swarm
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/jmarcos-cano/compose-to-swarm/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Single Engine
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Single Engine
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../docker/" title="Simple Docker" class="md-nav__link">
      Simple Docker
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../docker-compose/" title="Docker Compose" class="md-nav__link">
      Docker Compose
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../awesome-compose/" title="Awesome Compose" class="md-nav__link">
      Awesome Compose
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Multi Engine
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Multi Engine
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../intro-swarm/" title="Intro Docker Swarm" class="md-nav__link">
      Intro Docker Swarm
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Docker Swarm
      </label>
    
    <a href="./" title="Docker Swarm" class="md-nav__link md-nav__link--active">
      Docker Swarm
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#0-git-clone" class="md-nav__link">
    0. git clone
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-enable-visualizer-on-port-8080" class="md-nav__link">
    1. Enable Visualizer on port 8080
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-simple-service-create" class="md-nav__link">
    2. Simple service create
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-simple-stack-deploy" class="md-nav__link">
    3. Simple Stack deploy
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-environment-variables-injection" class="md-nav__link">
    4. Environment Variables injection
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-scale-web-app" class="md-nav__link">
    5. Scale web app
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-declarative-deployment-replicas" class="md-nav__link">
    6. Declarative Deployment Replicas
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-rolling-updates" class="md-nav__link">
    7. Rolling Updates
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lets-force-update-to-see-the-rolling-updates" class="md-nav__link">
    Lets force update to see the rolling updates
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-host-limit-resource" class="md-nav__link">
    8. Host limit resource
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-health-check-and-self-healing" class="md-nav__link">
    9. Health Check and Self healing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#full-production-lb" class="md-nav__link">
    Full Production + LB
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../compose-k8/" title="Compose in k8" class="md-nav__link">
      Compose in k8
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#0-git-clone" class="md-nav__link">
    0. git clone
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-enable-visualizer-on-port-8080" class="md-nav__link">
    1. Enable Visualizer on port 8080
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-simple-service-create" class="md-nav__link">
    2. Simple service create
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-simple-stack-deploy" class="md-nav__link">
    3. Simple Stack deploy
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-environment-variables-injection" class="md-nav__link">
    4. Environment Variables injection
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-scale-web-app" class="md-nav__link">
    5. Scale web app
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-declarative-deployment-replicas" class="md-nav__link">
    6. Declarative Deployment Replicas
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-rolling-updates" class="md-nav__link">
    7. Rolling Updates
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lets-force-update-to-see-the-rolling-updates" class="md-nav__link">
    Lets force update to see the rolling updates
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-host-limit-resource" class="md-nav__link">
    8. Host limit resource
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-health-check-and-self-healing" class="md-nav__link">
    9. Health Check and Self healing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#full-production-lb" class="md-nav__link">
    Full Production + LB
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/jmarcos-cano/compose-to-swarm/edit/master/docs/swarm.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="swarm-steps">Swarm Steps<a class="headerlink" href="#swarm-steps" title="Permanent link">&para;</a></h1>
<h2 id="0-git-clone">0. git clone<a class="headerlink" href="#0-git-clone" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span>git clone https://github.com/jmarcos-cano/compose-to-swarm.git
<span class="nb">cd</span> compose-to-swarm
</pre></div>

<h2 id="1-enable-visualizer-on-port-8080">1. Enable Visualizer on port 8080<a class="headerlink" href="#1-enable-visualizer-on-port-8080" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span>docker service create <span class="se">\</span>
  --name<span class="o">=</span>viz <span class="se">\</span>
  --publish<span class="o">=</span><span class="m">8080</span>:8080/tcp <span class="se">\</span>
  --constraint<span class="o">=</span>node.role<span class="o">==</span>manager <span class="se">\</span>
  --mount<span class="o">=</span><span class="nv">type</span><span class="o">=</span>bind,src<span class="o">=</span>/var/run/docker.sock,dst<span class="o">=</span>/var/run/docker.sock <span class="se">\</span>
  dockersamples/visualizer

<span class="c1"># wait until it says &quot;service converged&quot;</span>
</pre></div>

<details class="info"><summary>‚ö†Ô∏è</summary><p>go to your visualizer (click in your upper link port 8080) and see how the services are spread.</p>
</details>
<hr />
<h2 id="2-simple-service-create">2. Simple service create<a class="headerlink" href="#2-simple-service-create" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><span class="c1"># Create a swarm service from a Nginx docker image</span>
docker service create --name nginx-ws -p <span class="m">80</span>:80 nginx

<span class="c1"># List the current services</span>
docker service ls
</pre></div>

<details class="info"><summary>‚ö†Ô∏è</summary><p>Go to your visualizer (click in your upper link port 8080) and see how the services are spread.
Click also on Port 80 (Nginx) - it should say "Welcome to Nginx"</p>
</details>
<p><strong>Scale the service</strong>
<div class="codehilite"><pre><span></span>docker service update --replicas <span class="m">3</span> nginx-ws
</pre></div></p>
<blockquote>
<p>Go to your visualizer (click in your upper link port 8080) and see how the services are spread.</p>
</blockquote>
<p><strong>Checking service logs</strong>
<div class="codehilite"><pre><span></span>docker service logs nginx-ws
</pre></div></p>
<p><strong>Delete the service</strong>
<div class="codehilite"><pre><span></span>docker service rm nginx-ws

<span class="c1"># check for running services</span>
docker service ls
</pre></div></p>
<hr />
<h2 id="3-simple-stack-deploy">3. Simple Stack deploy<a class="headerlink" href="#3-simple-stack-deploy" title="Permanent link">&para;</a></h2>
<p><div class="codehilite"><pre><span></span><span class="c1"># inspect the stack file and try to understand it</span>
cat docker-compose.simple.yml
<span class="c1"># deploy it</span>
docker stack deploy -c docker-compose.simple.yml --resolve-image<span class="o">=</span>always --with-registry-auth compose_swarm

<span class="c1"># list current services</span>
docker service ls
</pre></div>
<br></p>
<details class="info"><summary>‚ö†Ô∏è</summary><p>Go to your app (click in your upper link port 500) and see how the app looks like. !
Go to your visualizer (click in your upper link port 8080) and see how the services are spread.</p>
</details>
<p>Show current status
<div class="codehilite"><pre><span></span>docker stack ps compose_swarm
</pre></div></p>
<hr />
<h2 id="4-environment-variables-injection">4. Environment Variables injection<a class="headerlink" href="#4-environment-variables-injection" title="Permanent link">&para;</a></h2>
<blockquote>
<p>üí° This will give you a small intro to how you can manage configuration per environment (dev,qa,stage,production)</p>
</blockquote>
<div class="codehilite"><pre><span></span><span class="c1"># inspect the stack file and try to find the directive &quot;FOO=${FOO:-BAR}&quot;</span>
cat docker-compose.simple.yml

<span class="c1"># inject the new value</span>
<span class="nb">export</span> <span class="nv">FOO</span><span class="o">=</span><span class="s2">&quot;Development&quot;</span>

<span class="c1"># deploy it and see it update automatically</span>
docker stack deploy -c docker-compose.simple.yml --resolve-image<span class="o">=</span>always --with-registry-auth compose_swarm

docker stack services compose_swarm
</pre></div>

<div class="codehilite"><pre><span></span><span class="c1"># PROD</span>
docker stack deploy -c &lt;<span class="o">(</span>docker-compose --env-file .configs/production.env -f docker-compose.simple.yml config <span class="o">)</span> --resolve-image<span class="o">=</span>always --with-registry-auth compose_swarm_prod
</pre></div>

<p><br></p>
<details class="info"><summary>ü•á</summary><p>Dare you to put your own Text there, see how sometimes the application becomes unaccessible?</p>
</details>
<hr />
<h2 id="5-scale-web-app">5. Scale web app<a class="headerlink" href="#5-scale-web-app" title="Permanent link">&para;</a></h2>
<ul>
<li>Want to handle more traffic?</li>
<li>Want to be more resilient?</li>
<li>Want High Availability?</li>
</ul>
<p>Swarm got you covered</p>
<p><div class="codehilite"><pre><span></span>docker service scale <span class="nv">compose_swarm_web</span><span class="o">=</span><span class="m">4</span>
</pre></div>
<br></p>
<details class="info"><summary>‚ö†Ô∏è</summary><p>Go to your app (click in your upper link port 500) and see how which task/container responds
Go to your visualizer (click in your upper link port 8080) and see how the services are spread.</p>
</details>
<hr />
<h2 id="6-declarative-deployment-replicas">6. Declarative Deployment Replicas<a class="headerlink" href="#6-declarative-deployment-replicas" title="Permanent link">&para;</a></h2>
<p>Instead of scaling your service everytime, why don't we declare it?</p>
<div class="codehilite"><pre><span></span><span class="c1"># Inspect the .replicas file and find &quot;deploy: &quot; section</span>
cat compose/docker-compose.replicas.yml

<span class="c1"># Deploy new update for the stack</span>
<span class="nv">DEPLOYMENT_REPLICAS</span><span class="o">=</span><span class="m">7</span> docker stack deploy -c compose/docker-compose.replicas.yml --resolve-image<span class="o">=</span>always compose_swarm
</pre></div>

<details class="info"><summary>‚ö†Ô∏è</summary><p>Go to your visualizer (click in your upper link port 8080) and see how the services are spread.</p>
</details>
<hr />
<h2 id="7-rolling-updates">7. Rolling Updates<a class="headerlink" href="#7-rolling-updates" title="Permanent link">&para;</a></h2>
<p>Rolling updates let you update your app with zero-downtime.
<br></p>
<blockquote>
<p>üí° v1 has been running for 2 weeks now and you are ready to ship your new and hottest feature on v2, with rolling updates you can easily ship v2 let it coexist with v1 until v1 gets fully drain (removed) and v2 gets out.</p>
</blockquote>
<div class="codehilite"><pre><span></span><span class="c1"># inspect .rolling file and find the &quot;update_config:&quot; section, try to understand it</span>
less compose/docker-compose.rolling.yml


<span class="c1"># Deploy/update this new configuration for your stack</span>
docker stack deploy -c &lt;<span class="o">(</span>docker-compose -f compose/docker-compose.rolling.yml config<span class="o">)</span> --resolve-image<span class="o">=</span>always compose_swarm

<span class="c1"># update image</span>
docker stack deploy -c &lt;<span class="o">(</span><span class="nv">IMAGE_NAME</span><span class="o">=</span>mcano/compose-to-swarm:v2 docker-compose -f compose/docker-compose.rolling.yml config<span class="o">)</span> --resolve-image<span class="o">=</span>always compose_swarm
</pre></div>

<h4 id="lets-force-update-to-see-the-rolling-updates">Lets force update to see the rolling updates<a class="headerlink" href="#lets-force-update-to-see-the-rolling-updates" title="Permanent link">&para;</a></h4>
<p>Do this how many times you need in order to see it working.</p>
<div class="codehilite"><pre><span></span><span class="c1"># graceful full restart of your app</span>
docker service update --force compose_swarm_web
</pre></div>

<blockquote>
<p>Go to your visualizer (click in your upper link port 8080) and see how the services are spread.</p>
</blockquote>
<hr />
<h2 id="8-host-limit-resource">8. Host limit resource<a class="headerlink" href="#8-host-limit-resource" title="Permanent link">&para;</a></h2>
<p>One can prevent memory starvation or CPU consumption of your app by adding "resources:" section</p>
<div class="codehilite"><pre><span></span><span class="c1"># inspect .resources file and find the &quot;resources:&quot; section, try to understand it</span>
less compose/docker-compose.resources.yml

<span class="c1"># Deploy/update this new configuration for your stack</span>
docker stack deploy -c compose/docker-compose.resources.yml --resolve-image<span class="o">=</span>always compose_swarm
</pre></div>

<h2 id="9-health-check-and-self-healing">9. Health Check and Self healing<a class="headerlink" href="#9-health-check-and-self-healing" title="Permanent link">&para;</a></h2>
<p>Auto restarts and health-check can also be possible by adding "healthcheck: "</p>
<div class="codehilite"><pre><span></span><span class="c1"># Run docker ps first to see there&#39;s no (healthy)</span>
docker ps

<span class="c1"># inspect .health file and find the &quot;healthcheck:&quot; section, try to understand it</span>
less compose/docker-compose.health.yml

<span class="c1"># Deploy/update this new configuration for your stack</span>
docker stack deploy -c compose/docker-compose.health.yml --resolve-image<span class="o">=</span>always compose_swarm

<span class="c1"># after a few seconds run</span>
docker ps
</pre></div>

<p>Do a: <code class="codehilite">docker service ps compose_swarm_web</code>, Identify the placement of a container (identify on which node is running).</p>
<p>Jump into that node and run <code class="codehilite">docker ps</code> find the container and its ID (first column), kill it and see how it self heals
<div class="codehilite"><pre><span></span>docker <span class="nb">kill</span> &lt;container ID&gt;
</pre></div></p>
<details class="info"><summary>info</summary><p>Go to your visualizer (click in your upper link port 8080) and see how the services are spread and self healed.</p>
</details>
<h2 id="full-production-lb">Full Production + <a href="http://138-197-49-123.nip.io/">LB</a><a class="headerlink" href="#full-production-lb" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span>docker stack deploy -c &lt;(docker-compose --env-file .configs/production.env -f docker-compose.yml config ) --resolve-image=always --with-registry-auth compose_swarm_prod

open http://138-197-49-123.nip.io/
</pre></div>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../intro-swarm/" title="Intro Docker Swarm" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Intro Docker Swarm
              </span>
            </div>
          </a>
        
        
          <a href="../compose-k8/" title="Compose in k8" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Compose in k8
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.ac79c3b0.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
        <script src="https://unpkg.com/mermaid@7.1.2/dist/mermaid.min.js"></script>
      
    
  </body>
</html>